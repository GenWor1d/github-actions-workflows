name: 通用部署
on:
  workflow_call:
    inputs:
      branch:
        required: false
        type: string
        default: ${{ github.ref_name }}
      working-directory:
        required: false
        type: string
        default: 'deployment'
      env-file:
        description: 'Docker Compose 环境文件路径'
        required: false
        type: string
        default: ''

jobs:
  deploy:
    name: 部署${{ inputs.branch }}-${{ github.run_number }}
    runs-on: ${{ github.ref_name }}
    defaults:
      run:
        working-directory: ${{ inputs.working-directory }}
    
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 设置环境变量
        run: |
          IMAGE_TAG="${{ inputs.branch }}-$(TZ='Asia/Shanghai' date +%Y%m%d-%H%M%S)"
          PROJECT_NAME=$(basename $GITHUB_WORKSPACE | tr '[:upper:]' '[:lower:]')
          
          echo "部署信息:"
          echo "  分支: ${{ inputs.branch }}"
          echo "  项目: $PROJECT_NAME"
          echo "  标签: $IMAGE_TAG"
          
          # 保存环境变量
          echo "BRANCH_NAME=${{ inputs.branch }}" >> $GITHUB_ENV
          echo "PROJECT_NAME=$PROJECT_NAME" >> $GITHUB_ENV
          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV
          echo "CONTAINER_NAME=$PROJECT_NAME" >> $GITHUB_ENV
          echo "NETWORK_NAME=gen-world-bridge" >> $GITHUB_ENV

      - name: 创建配置文件
        run: |
          # 创建基础配置文件
          cat > .env << EOF
          BRANCH_NAME=${{ env.BRANCH_NAME }}
          PROJECT_NAME=${{ env.PROJECT_NAME }}
          IMAGE_TAG=${{ env.IMAGE_TAG }}
          CONTAINER_NAME=${{ env.CONTAINER_NAME }}
          NETWORK_NAME=${{ env.NETWORK_NAME }}
          EOF
          
          # 合并自定义环境文件
          [ -n "${{ inputs.env-file }}" ] && cat ${{ inputs.env-file }} >> .env || true

      - name: 配置Docker环境
        run: |
          # 创建Docker网络
          docker network create ${{ env.NETWORK_NAME }} 2>/dev/null || true

      - name: 执行预部署脚本
        run: |
          # 执行部署工具目录下的自定义脚本
          DEPLOY_TOOLS="$PWD/scripts"
          [ ! -d "$DEPLOY_TOOLS" ] && echo "未找到部署工具目录，跳过脚本执行" && exit 0
          
          SCRIPT_FOUND=false
          for script in "$DEPLOY_TOOLS"/*.sh; do
            [ -f "$script" ] && {
              SCRIPT_FOUND=true
              echo "执行: $(basename "$script")"
              # 转换换行符格式
              sed -i 's/\r$//' "$script"
              chmod +x "$script"
              "$script" || echo "脚本执行失败: $(basename "$script")"
            }
          done
          
          [ "$SCRIPT_FOUND" = false ] && echo "未找到可执行的脚本"

      - name: 构建镜像
        run: |
          echo "构建Docker镜像..."
          docker compose --env-file .env --project-name "${{ env.PROJECT_NAME }}" build

      - name: 清理旧容器
        run: |
          echo "清理现有容器..."
          docker rm -f "${{ env.CONTAINER_NAME }}" 2>/dev/null || true
          docker compose --env-file .env --project-name "${{ env.PROJECT_NAME }}" down --remove-orphans 2>/dev/null || true

      - name: 部署服务
        run: |
          echo "启动新容器..."
          docker compose --env-file .env --project-name "${{ env.PROJECT_NAME }}" up -d --force-recreate
          sleep 5
          docker logs "${{ env.CONTAINER_NAME }}" --tail 20

      - name: 清理镜像
        run: |
          OLD_IMAGES=$(docker images --format "{{.Repository}}:{{.Tag}}" | \
                     grep "^${{ env.PROJECT_NAME }}:${{ env.BRANCH_NAME }}-" | \
                     sort -r | tail -n +3)
          
          [ -n "$OLD_IMAGES" ] && {
            echo "清理旧镜像:"
            echo "$OLD_IMAGES"
            echo "$OLD_IMAGES" | xargs -r docker rmi 2>/dev/null || true
          } || echo "无需清理镜像"
