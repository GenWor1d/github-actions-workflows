# 通用部署配置 - 可重用工作流
# 根据分支自动生成镜像标签，无需环境配置文件
# name: 通用部署-${{ github.run_number }}-${{ github.run_attempt }}
name: 通用部署
on:
  workflow_call:
    # 定义可选输入参数
    inputs:
      branch:
        description: '部署分支'
        required: false
        type: string
        default: ${{ github.ref_name }}
      working-directory:
        description: '部署脚本工作目录'
        required: false
        type: string
        default: 'deployment'

jobs:
  deploy:
    name: 部署${{ inputs.branch }}环境-${{ github.run_number }}
    runs-on: ${{ inputs.branch }}
    
    steps:
      - name: 检出代码
        uses: actions/checkout@v4
        
      - name: 设置环境变量
        working-directory: ${{ inputs.working-directory }}
        run: |
          # 生成包含日期时间的镜像标签
          echo "IMAGE_TAG=${{ inputs.branch }}-$(date +%Y%m%d-%H%M%S)" >> $GITHUB_ENV
          
          # 获取项目目录名作为镜像名称
          echo "PROJECT_NAME=$(basename $GITHUB_WORKSPACE)" >> $GITHUB_ENV
          
          # 设置分支名称环境变量，供后续compose使用
          echo "BRANCH_NAME=${{ inputs.branch }}" >> $GITHUB_ENV

          # 设置网络名称环境变量，供后续compose使用
          echo "NETWORK_NAME=gen-world-bridge" >> $GITHUB_ENV
          
      - name: 创建外部网络（如果不存在）
        working-directory: ${{ inputs.working-directory }}
        run: |
          docker network create --driver bridge ${{ env.NETWORK_NAME }} || true
          
      - name: 构建Docker镜像
        working-directory: ${{ inputs.working-directory }}
        run: |
          docker compose build
          
      - name: 启动新容器（保留旧容器）
        working-directory: ${{ inputs.working-directory }}
        run: |
          # 使用临时容器名称启动新容器
          CONTAINER_NAME=${{ env.PROJECT_NAME }}-new docker compose up -d
          
      - name: 验证新容器
        working-directory: ${{ inputs.working-directory }}
        run: |
          sleep 5
          if ! docker ps --filter "name=${{ env.PROJECT_NAME }}-new" --filter "status=running" -q; then
            echo "新容器启动失败" && docker logs ${{ env.PROJECT_NAME }}-new && exit 1
          fi
          
      - name: 替换容器
        working-directory: ${{ inputs.working-directory }}
        run: |
          # 替换旧容器为新容器
          docker stop ${{ env.PROJECT_NAME }} || true
          docker rm -f ${{ env.PROJECT_NAME }} || true
          docker rename ${{ env.PROJECT_NAME }}-new ${{ env.PROJECT_NAME }}
          
      - name: 清理旧镜像
        working-directory: ${{ inputs.working-directory }}
        run: |
          # 清理旧镜像（保留最新5个版本）
          docker images ${{ env.PROJECT_NAME }}:${{ inputs.branch }}-* --sort=-created --format "{{.Repository}}:{{.Tag}}" | tail -n +6 | xargs -r docker rmi || true
          # 清理悬挂镜像
          docker rmi $(docker images -f dangling=true -q) 2>/dev/null || true
          
      - name: 部署完成
        run: |
          echo "✅ 部署完成 - 镜像: ${{ env.PROJECT_NAME }}:${{ env.IMAGE_TAG }}"