name: 通用部署
on:
  workflow_call:
    inputs:
      branch:
        required: false
        type: string
        default: ${{ github.ref_name }}
      working-directory:
        required: false
        type: string
        default: 'deployment'

jobs:
  setup:
    name: 环境配置
    uses: ./.github/workflows/setup-env.yml
    with:
      branch: ${{ inputs.branch }}
      working-directory: ${{ inputs.working-directory }}
    
  pre-deploy:
    name: 执行自定义预部署任务
    needs: setup
    runs-on: ${{ github.ref_name }}
    steps:
      - name: 检出代码
        uses: actions/checkout@v3
        with:
          ref: ${{ inputs.branch }}
          fetch-depth: 1
      
      - name: 执行预部署脚本
        run: |
          # 先检查脚本文件是否存在
          if [ -f "./deployment/scripts/pre-deploy.sh" ]; then
            echo "找到预部署脚本文件"
            chmod +x ./deployment/scripts/pre-deploy.sh
            ./deployment/scripts/pre-deploy.sh
          else
            echo "预部署脚本文件不存在"
            ls -la ./deployment/scripts/
            exit 1
          fi

  network:
    name: 配置网络
    needs: pre-deploy
    uses: ./.github/workflows/docker-network.yml
    
  build:
    name: 构建镜像
    needs: network
    uses: ./.github/workflows/docker-image.yml
    
  deploy:
    name: 部署容器
    needs: [setup, network, build]
    uses: ./.github/workflows/docker-container.yml
    
  cleanup:
    name: 清理镜像
    needs: deploy
    uses: ./.github/workflows/docker-cleanup.yml
    with:
      image-name: ${{ github.repository }}